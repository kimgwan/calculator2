<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KW2NJFNG');</script>
    <!-- End Google Tag Manager -->
    <title>상품 관리 시스템</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://ai-public.creatie.ai/gen_page/tailwind-custom.css" rel="stylesheet" />
    <script
        src="https://cdn.tailwindcss.com/3.4.5?plugins=forms@0.5.7,typography@0.5.13,aspect-ratio@0.4.2,container-queries@0.1.1"></script>
    <script src="https://ai-public.creatie.ai/gen_page/tailwind-config.min.js" data-color="#000000"
        data-border-radius="small"></script>
    <style>
        .hide {
            display: none;
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5400288684880076"
    crossorigin="anonymous"></script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RVKHM2L309"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RVKHM2L309');
</script>
<body class="min-h-screen bg-gray-50">

    <%- include('nav.ejs') %>

        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="hide">
                <p>계정정보</p>
                <input type="text" name="userId" value="<%= user.userId %>" readonly>
            </div>
            <div class="mb-8">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8">
                        <a class="text-custom border-custom py-4 px-1 border-b-2 font-medium cursor-pointer"
                            id="list-tap"> 상품목록 </a>
                        <a class="text-gray-500 hover:text-gray-700 py-4 px-1 border-b-2 border-transparent cursor-pointer"
                            id="add-tap"> 상품입력 </a>
                    </nav>
                </div>
            </div>

            <div class="mt-8 space-y-6 tab-content" id="product-list">
                <div class="bg-white shadow rounded-lg flex items-center space-x-6 p-6">
                    <div class="flex-1">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input id="searchInput" type="text"
                                class="shadow-sm focus:ring-custom focus:border-custom block w-full pl-10 sm:text-sm border-gray-300 !rounded-button"
                                placeholder="상품명 또는 상품코드로 검색" />
                        </div>
                    </div>
                    <button
                        class="!rounded-button bg-custom text-white px-4 py-2 text-sm font-medium hover:bg-custom/90">검색</button>
                </div>
                <% if(productsData.length=='' ){ %>
                    <p class="text-gray-500">아직 저장된 상품 없어요.</p>
                    <p class="text-gray-500">상품입력에서 상품을 추가해보세요.</p>
                    <% } else { %>
                        <% for (let i=0; i < productsData.length; i++) { %>
                            <form action="delProduct" method="POST">
                                <input type="hidden" name="_id" value="<%= productsData[i]._id %>">
                                <div class="bg-white shadow rounded-lg p-6 mt-6">
                                    <div class="grid grid-cols-1 gap-y-8 relative">
                                        <div class="col-span-1 mb-6">
                                            <label class="block text-sm font-medium text-gray-700">상품명</label>
                                            <div class="mt-1 relative w-1/2">
                                                <input type="text" value="<%= productsData[i].productTitle %>"
                                                    class="shadow-sm focus:ring-custom focus:border-custom block w-full sm:text-sm border-gray-300 !rounded-button bg-white"
                                                    placeholder="상품명 입력" />
                                            </div>
                                            <div class="absolute right-0 top-0 flex space-x-2">
                                                <button class="text-blue-600 hover:text-blue-800 mr-3 edit-btn"><i
                                                        class="fas fa-edit"></i></button>
                                                <button type="submin" type="submit"
                                                    class="text-red-600 hover:text-red-800 del-btn"><i
                                                        class="fas fa-trash"></i></button>
                                            </div>
                                        </div>


                                        <div class="grid grid-cols-3 gap-8">
                                            <div class="col-span-1"><label
                                                    class="block text-sm font-medium text-gray-700">판매가</label>
                                                <div class="mt-1">
                                                    <input type="text"
                                                        class="shadow-sm focus:ring-custom focus:border-custom block w-full sm:text-sm border-gray-300 !rounded-button"
                                                        value="<%= productsData[i].productPrice %>" readonly />
                                                </div>
                                            </div>
                                            <div class="col-span-1"><label
                                                    class="block text-sm font-medium text-gray-700">원가</label>
                                                <div class="mt-1">
                                                    <input type="text"
                                                        class="shadow-sm focus:ring-custom focus:border-custom block w-full sm:text-sm border-gray-300 !rounded-button"
                                                        value="<%= productsData[i].totalValue %>" readonly />
                                                </div>
                                            </div>
                                            <div class="col-span-1"><label
                                                    class="block text-sm font-medium text-gray-700">원가율
                                                    (%)</label>
                                                <div class="mt-1"><input type="text"
                                                        class="shadow-sm focus:ring-custom focus:border-custom block w-full sm:text-sm border-gray-300 !rounded-button"
                                                        readonly="" value="<%= productsData[i].costRatio %>%"
                                                        readonly />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <% } %>
                                <% } %>
            </div>

            <form action="/saveProduct" method="POST">
                <div class="hide">
                    <p>계정정보</p>
                    <input type="text" name="userId" value="<%= user.userId %>" readonly>
                </div>
                <div class="bg-white shadow rounded-lg p-6 hidden" id="add-product">
                    <div class="mb-6 space-y-4">
                        <div class="flex-1 w-1/2"><label
                                class="block text-sm font-medium text-gray-700 mb-1">상품명</label><input type="text"
                                name="productTitle"
                                class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom sm:text-sm"
                                placeholder="상품명을 입력하세요" />
                        </div>
                        <div class="flex-1 w-1/2"><label
                                class="block text-sm font-medium text-gray-700 mb-1">판매가</label><input type="number"
                                name="productPrice"
                                class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom sm:text-sm"
                                placeholder="판매가를 입력하세요" />
                        </div>
                    </div>
                    <div class="flex-1 w-1/2"><label class="block text-sm font-medium text-gray-700 mb-1">재료 선택 </label>
                    </div>
                    <div class="space-y-4">
                        <% for (let i=0; i < 10; i++) { %>
                            <div class="grid grid-cols-12 gap-4 items-center">
                                <div class="col-span-3">
                                    <select
                                        class="materialName block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom sm:text-sm">
                                        <option></option>
                                        <% if(materialsData.length=='' ){ %>
                                            <option>아직 저장된 재료가 없어요.</option>
                                            <option>재료입력에서 재료를 추가해보세요.</option>
                                            <% } else { %>
                                                <% for (let i=0; i < materialsData.length; i++) { %>
                                                    <option>
                                                        <%= materialsData[i].mname %>
                                                    </option>
                                                    <% } %>
                                                        <% } %>
                                    </select>
                                </div>
                                <div class="col-span-3">
                                    <div class="flex items-center space-x-2">
                                        <input type="number"
                                            class="cap block w-full border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom sm:text-sm"
                                            placeholder="중량 입력" />
                                        <span class="text-gray-500">g</span>
                                    </div>
                                </div>
                                <div class="col-span-3 hide">
                                    <input type="text"
                                        class="minPriceValue block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm focus:ring-custom focus:border-custom sm:text-sm"
                                        placeholder="계산값" readonly/>
                                </div>
                            </div>
                            <% } %>

                                <div class="flex items-end">
                                    <button type="submit"
                                        class="!rounded-button bg-custom text-white px-4 py-2 text-sm font-medium hover:bg-custom/90">저장</button>
                                </div>
                                <div class="border-t border-gray-200 pt-4 mt-6">
                                    <div class="flex justify-end items-center space-x-4">
                                        <span class="text-sm font-medium text-gray-700">총 원가:</span>
                                        <input type="text" name="totalValue"
                                            class="totalValue text-lg font-semibold text-custom bg-transparent border-none"
                                            readonly />
                                    </div>
                                </div>
                    </div>
                </div>
        </div>
        </form>
        

        <script>

            document.getElementById('searchInput').addEventListener('input', function () {
                const filter = this.value.toLowerCase(); // 검색어를 소문자로 변환
                const productDivs = document.querySelectorAll('.bg-white.shadow.rounded-lg.p-6.mt-6'); // 상품 목록의 모든 카드

                productDivs.forEach(product => {
                    const productName = product.querySelector('input[type="text"]').value.toLowerCase(); // 상품명
                    if (productName.includes(filter)) {
                        product.style.display = ''; // 검색어가 포함되면 보이기
                    } else {
                        product.style.display = 'none'; // 검색어가 포함되지 않으면 숨기기
                    }
                });
            });


            const materialsData = <%- JSON.stringify(materialsData) %>

                // 모든 계산값을 더해서 totalValue에 반영하는 함수
                function updateTotalValue() {
                    let total = 0;

                    // 모든 minPriceValue의 값을 더함
                    document.querySelectorAll('.minPriceValue').forEach(minPriceValueInput => {
                        const value = parseFloat(minPriceValueInput.value) || 0;
                        total += value;
                    });

                    // totalValue에 총합을 넣음
                    document.querySelectorAll('.totalValue').forEach(totalValueInput => {
                        totalValueInput.value = total.toFixed(2); // 소수점 2자리로 표시
                    });
                }

            // 각 반복문에 대한 이벤트 리스너를 적용
            document.querySelectorAll('.materialName').forEach((materialNameSelect, index) => {
                materialNameSelect.addEventListener('input', function () {
                    const selectedValue = materialNameSelect.value;
                    const capValue = document.querySelectorAll('.cap')[index].value;
                    const minPriceValueInput = document.querySelectorAll('.minPriceValue')[index];

                    // 재료명과 중량에 따른 계산값 업데이트
                    for (let i = 0; i < materialsData.length; i++) {
                        if (selectedValue == materialsData[i].mname) {
                            minPriceValueInput.value = materialsData[i].minPrice * capValue;
                        }
                    }

                    // totalValue를 업데이트
                    updateTotalValue();
                });
            });

            document.querySelectorAll('.cap').forEach((capInput, index) => {
                capInput.addEventListener('input', function () {
                    const selectedValue = document.querySelectorAll('.materialName')[index].value;
                    const capValue = capInput.value;
                    const minPriceValueInput = document.querySelectorAll('.minPriceValue')[index];

                    // 재료명과 중량에 따른 계산값 업데이트
                    for (let i = 0; i < materialsData.length; i++) {
                        if (selectedValue == materialsData[i].mname) {
                            minPriceValueInput.value = materialsData[i].minPrice * capValue;
                        }
                    }

                    // totalValue를 업데이트
                    updateTotalValue();
                });
            });


            document.querySelector('#add-tap').addEventListener('click', function () {
                document.querySelector('#product-list').classList.add('hidden')
                document.querySelector('#add-product').classList.remove('hidden')
            })

            document.querySelector('#list-tap').addEventListener('click', function () {
                document.querySelector('#product-list').classList.remove('hidden')
                document.querySelector('#add-product').classList.add('hidden')
            })

            document.querySelector('#add-tap').addEventListener('click', function () {
                document.querySelector('#add-tap').classList.remove('text-gray-500')
                document.querySelector('#add-tap').classList.remove('hover:text-gray-700')
                document.querySelector('#add-tap').classList.remove('border-transparent')
                document.querySelector('#add-tap').classList.add('text-custom')
                document.querySelector('#add-tap').classList.add('border-custom')
                document.querySelector('#add-tap').classList.add('font-medium')
                document.querySelector('#list-tap').classList.remove('text-custom')
                document.querySelector('#list-tap').classList.remove('border-custom')
                document.querySelector('#list-tap').classList.remove('font-medium')
                document.querySelector('#list-tap').classList.add('text-gray-500')
                document.querySelector('#list-tap').classList.add('hover:text-gray-700')
                document.querySelector('#list-tap').classList.add('border-transparent')
            })

            document.querySelector('#list-tap').addEventListener('click', function () {
                document.querySelector('#list-tap').classList.remove('text-gray-500')
                document.querySelector('#list-tap').classList.remove('hover:text-gray-700')
                document.querySelector('#list-tap').classList.remove('border-transparent')
                document.querySelector('#list-tap').classList.add('text-custom')
                document.querySelector('#list-tap').classList.add('border-custom')
                document.querySelector('#list-tap').classList.add('font-medium')
                document.querySelector('#add-tap').classList.remove('text-custom')
                document.querySelector('#add-tap').classList.remove('border-custom')
                document.querySelector('#add-tap').classList.remove('font-medium')
                document.querySelector('#add-tap').classList.add('text-gray-500')
                document.querySelector('#add-tap').classList.add('hover:text-gray-700')
                document.querySelector('#add-tap').classList.add('border-transparent')
            })

        </script>
</body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KW2NJFNG"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
</html>